sub20 = '/Users/hatle/Documents/Intro Comp Med/Patient Data/OneDrive/s00020-2567-03-30-17-47_ABP.txt';
nfile = '/Users/hatle/Documents/Intro Comp Med/Patient Data/OneDrive/s00020-2567-03-30-17-47n.txt';

% sub20 = 'D:\Users\Richard\Documents\s00020-2567-03-30-17-47_ABP.txt';
% nfile = 'D:\Users\Richard\Documents\s00020-2567-03-30-17-47n.txt';

addpath('/Users/hatle/Documents/Intro Comp Med/Project_Assignments/PhysioToolkitCardiacOutput_MatlabCode/2analyze');
addpath('/Users/hatle/Documents/Intro Comp Med/Project_Assignments/PhysioToolkitCardiacOutput_MatlabCode/3estimate');

% Produce estimates without calibration
abpfile = importdata(sub20);
abp = abpfile(:,2);
otimes = wabp(abp);
feat = abpfeature(abp, otimes);
beatq = jSQI(feat, otimes, abp);
[estimates, timemin] = estimateCO_v3(otimes, feat, beatq, 5, 100);

% Calibrate estimates against CO from thermodilution
ntable = readtable(nfile, 'Delimiter', 'tab');
COdouble = str2double(table2cell(ntable(2:end,16)));

%Get PP, MAP and HR from features file
PP = feat(:,5);
MAP = feat(:,6);
HR = feat(:,7);

% Finding the first nonzero COtd value and its time
firstind = 1;
while COdouble(firstind) == 0
    firstind = firstind+1;
end
COtdtime = (firstind-1); %first nonzero value time (min)

% Finding the closest estimates time point to the first COtd measurement
n = 1;
min = intmax;
while abs(timemin(n) - COtdtime) < min
    min = abs(timemin(n) - COtdtime);
    n = n+1;
end
C2ratio = COdouble(firstind)/estimates(n-1);

% Performing calibration calculations and plotting
estimates = estimates*C2ratio;
n = 1;
min = intmax;
while abs(timemin(n) - 720) < min
    min = abs(timemin(n) - 720);
    n = n+1;
end

figure
ax1 = subplot(2,1,1);
ax2 = subplot(2,1,2);
ax3 = subplot(2,1,3);
ax4 = subplot(2,1,4);
plot(ax1,timemin(1:n), estimates(1:n));

xlabel(ax1,'time (min)')
ylabel(ax1,'Cardiac Output (L/min)')

plot(ax2,timemin(1:n), PP(1:n));

xlabel(ax1,'time (min)')
ylabel(ax1,'Cardiac Output (L/min)')

plot(ax3,timemin(1:n), MAP(1:n));
title(ax1,'Continuous Estimated Cardiac Output (Calibrated)')
xlabel(ax1,'time (min)')
ylabel(ax1,'Cardiac Output (L/min)')

plot(ax4,timemin(1:n), HR(1:n));
title(ax1,'Continuous Estimated Cardiac Output (Calibrated)')
xlabel(ax1,'time (min)')
ylabel(ax1,'Cardiac Output (L/min)')


